## Dryrun, Mocks, and Tests (required)

Required loop (do not skip steps):
1. `nango dryrun ... --validate -e dev --no-interactive --auto-confirm` until it passes (actions: never omit `--input`).
2. If validation can't pass, stop and return early stating the missing external state/inputs required (never hand-author `*.test.json`).
3. After validation passes, run `nango dryrun ... --save -e dev --no-interactive --auto-confirm` to generate `<script-name>.test.json`.
4. Run `nango generate:tests` to generate/update `<script-name>.test.ts`.
5. Run `npm test`.

Default non-interactive flags (use these unless you have a reason not to):
- `-e dev --no-interactive --auto-confirm`

### nango dryrun

Basic syntax:

```
nango dryrun <script-name> <connection-id> [flags]
```

Actions (always pass `--input`):

Validate:

```
nango dryrun <action-name> <connection-id> --validate -e dev --no-interactive --auto-confirm --input '{"key":"value"}'

# For no-input actions (input: z.object({}))
nango dryrun <action-name> <connection-id> --validate -e dev --no-interactive --auto-confirm --input '{}'
```

After validation passes, record mocks (generates `<action-name>.test.json`):

```
nango dryrun <action-name> <connection-id> --save -e dev --no-interactive --auto-confirm --input '{"key":"value"}'
```

Syncs:

Validate:

```
nango dryrun <sync-name> <connection-id> --validate -e dev --no-interactive --auto-confirm
```

After validation passes, record mocks (generates `<sync-name>.test.json`):

```
nango dryrun <sync-name> <connection-id> --save -e dev --no-interactive --auto-confirm
```

Incremental sync testing:

```
nango dryrun <sync-name> <connection-id> --validate -e dev --no-interactive --auto-confirm --lastSyncDate "YYYY-MM-DD"
```

Stub metadata (when your function calls nango.getMetadata()):

```
# Action (still requires --input)
nango dryrun <action-name> <connection-id> --validate -e dev --no-interactive --auto-confirm --input '{}' --metadata '{"team_id":"123"}'

# Sync
nango dryrun <sync-name> <connection-id> --validate -e dev --no-interactive --auto-confirm --metadata @fixtures/metadata.json
```

Notes:
- Connection ID is the second positional argument (no `--connection-id` flag).
- Use `--integration-id <integration-id>` when script names overlap across integrations.
- Common flags: `--variant <name>`.
- If you do not have `nango` on PATH, use `npx nango ...`.
- CLI upgrade prompts can block non-interactive runs. Workaround: set `NANGO_CLI_UPGRADE_MODE=ignore`.

### nango generate:tests

Generate/update tests (required):

```
nango generate:tests
```

Optionally narrow generation:

```
nango generate:tests -i <integrationId>
nango generate:tests -i <integrationId> -a <action-name>
nango generate:tests -i <integrationId> -s <sync-name>
```

### Test artifacts

```
{integrationId}/tests/
|-- <script-name>.test.ts
`-- <script-name>.test.json
```

- Ensure `<script-name>.test.json` exists (generated by `nango dryrun ... --save` after a successful `--validate`). Never hand-author `*.test.json`.
- `<script-name>.test.json` contains recorded API mocks + expected input/output.
- `<script-name>.test.ts` is generated/updated by `nango generate:tests`.

Reference: https://nango.dev/docs/implementation-guides/platform/functions/testing
